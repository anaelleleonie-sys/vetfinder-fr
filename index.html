<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vétérinaires à proximité — France</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f7f7f8;margin:0;padding:24px;color:#111}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:20px;max-width:820px;margin:0 auto}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:8px;align-items:center;margin:12px 0}
    input,select,button{font-size:16px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px}
    input{flex:1}
    button{background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .error{color:#b91c1c;margin:8px 0}
    .item{padding:12px 0;border-bottom:1px solid #eee}
    .item:last-child{border-bottom:none}
    .name{font-weight:600;margin-bottom:4px}
    .meta{font-size:14px;color:#555}
    .meta a{color:#2563eb;text-decoration:none}
    .footer{margin-top:16px;font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h1>Entrez un code postal pour trouver des vétérinaires à proximité</h1>
    <div class="row">
      <input id="cp" placeholder="ex : 33000" maxlength="5" />
      <select id="radius">
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <button id="btn">Rechercher</button>
    </div>
    <div id="error" class="error" style="display:none"></div>
    <div id="list"></div>
    <div class="footer">Données : © OpenStreetMap contributors — Affichage généré côté navigateur.</div>
  </div>

<script>
const DATA_URL = 'vets-fr.min.json'; // remplacé plus tard par la France entière via ETL
let DATA = [];

function hostname(u){ try { return new URL(u).hostname; } catch(e){ return ''; } }
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371000; // m
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

async function loadData(){
  const res = await fetch(DATA_URL);
  if(!res.ok) throw new Error('Impossible de charger les données.');
  DATA = await res.json();
}

async function geocodeCP(cp){
  const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=fr&postalcode=${encodeURIComponent(cp)}`;
  const res = await fetch(url, { headers: { 'Accept-Language': 'fr' } });
  const json = await res.json();
  if(!json || !json.length) throw new Error('Code postal introuvable.');
  return { lat: parseFloat(json[0].lat), lon: parseFloat(json[0].lon) };
}

function render(list){
  const root = document.getElementById('list');
  root.innerHTML = '';
  if(!list.length){ root.innerHTML = '<p>Aucun résultat dans ce rayon.</p>'; return; }
  for(const r of list){
    const div = document.createElement('div');
    div.className = 'item';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = r.name;

    const site = r.website ? `<a href="${r.website}" target="_blank" rel="noreferrer">${hostname(r.website)}</a>` : `<a href="https://www.google.com/search?q=${encodeURIComponent(r.name + ' vétérinaire ')}" target="_blank" rel="noreferrer">Recherche Google</a>`;

    const distKm = (r._dist/1000).toFixed(1);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = [
      r.address || 'Adresse non renseignée',
      site,
      r.phone ? `<a href="tel:${r.phone}">${r.phone}</a>` : '',
      `${distKm} km`
    ].filter(Boolean).join(' • ');

    div.appendChild(name);
    div.appendChild(meta);
    root.appendChild(div);
  }
}

async function onSearch(){
  const btn = document.getElementById('btn');
  const err = document.getElementById('error');
  const cp = (document.getElementById('cp').value || '').trim();
  const radius = parseInt(document.getElementById('radius').value, 10);
  err.style.display = 'none'; err.textContent = '';
  try{
    if(!/^\d{5}$/.test(cp)) throw new Error('Entre un code postal à 5 chiffres.');
    btn.disabled = true; btn.textContent = 'Recherche…';

    if(!DATA.length) await loadData();
    const { lat, lon } = await geocodeCP(cp);

    const list = DATA.map(x => ({...x, _dist: haversine(lat, lon, x.lat, x.lon)}))
                     .filter(x => x._dist <= radius)
                     .sort((a,b) => a._dist - b._dist)
                     .slice(0, 200);

    render(list);
  }catch(e){
    err.textContent = e.message || 'Erreur inattendue';
    err.style.display = 'block';
  }finally{
    btn.disabled = false; btn.textContent = 'Rechercher';
  }
}

document.getElementById('btn').addEventListener('click', onSearch);
document.getElementById('cp').addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSearch(); });
</script>
</body>
</html>
